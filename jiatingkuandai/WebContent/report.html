<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>家庭宽带品质数据平台 | 测试报告</title>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="adminLTE_zx/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="adminLTE_zx/bootstrap/css/font-awesome.min.css">
  <link rel="stylesheet" href="adminLTE_zx/bootstrap/css/ionicons.min.css"> 
  <link rel="stylesheet" href="adminLTE_zx/dist/css/AdminLTE.min.css">
  <link rel="stylesheet" href="adminLTE_zx/dist/css/skins/_all-skins.min.css">

</head> 
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

  <header class="main-header">
    <a onclick="targetFunc('index.html','indexhead')" id="indexhead" href="" class="logo">
      <span class="logo-mini">家宽</span>
	   <span class="logo-lg"><img src="images/jiating.png"></span>
    </a>
    <nav class="navbar navbar-static-top" role="navigation">
      <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
      </a>
      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          <li class="dropdown user user-menu">
            <a  class="" data-toggle="">
              <img src="adminLTE_zx/dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
              <span class="hidden-xs"></span>
            </a>
          </li>
          <li>
            <a href="" onclick="loginout()">退出</a>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <aside class="main-sidebar">
    <section class="sidebar">
      <ul class="sidebar-menu">
        <li class="header">导航栏</li>
        <li>
          <a onclick="targetFunc('index.html','indexOver')" id="indexOver" href="">
            <i><img src="images/dashboard.png"></i> <span>概览</span> <i class=""></i>
          </a>
        </li>
        <li>
          <a onclick="targetFunc('user.html','yhAnaly')" id="yhAnaly" href="">
            <i><img src="images/useranalysis.png"></i> <span>用户分析</span>
          </a>
        </li>
        <li>
          <a onclick="targetFunc('terminal.html','zdAnaly')" href="" id="zdAnaly">
            <i><img src="images/terminalanalysis.png"></i> <span>终端分析</span>
          </a>
        </li>
        <li class="treeview">
          <a href="#">
            <i><img src="images/biz.png"></i> <span>业务质量</span> <i class="fa fa-angle-left pull-right"></i>
          </a>
          <ul class="treeview-menu">
            <li class="active"><a onclick="targetProbeFunc('servicequality.html','ywAndroid','Android')" href="" id="ywAndroid">
            	<i class="fa fa-circle-o"></i>安卓</a></li>
            <li ><a onclick="targetProbeFunc('servicequality.html','ywiOS','iOS')" href="" id="ywiOS">
            	<i class="fa fa-circle-o"></i>苹果</a></li>
            <li ><a onclick="targetProbeFunc('servicequality.html','ywPC','PC')" href="" id="ywPC">
            	<i class="fa fa-circle-o"></i>桌面</a></li>
           <!--  <li ><a onclick="targetProbeFunc('servicequality.html','ywQianrushi','嵌入式')" href="" id="ywQianrushi">
            	<i class="fa fa-circle-o"></i>嵌入式</a></li>
            <li ><a onclick="targetProbeFunc('servicequality.html','ywRuantanzhen','软探针')" href="" id="ywRuantanzhen">
            	<i class="fa fa-circle-o"></i>软探针</a></li> -->
          </ul>
        </li>
        <li>
          <a onclick="targetFunc('network.html','wlAnaly')" href="" id="wlAnaly">
            <i><img src="images/netanalysis.png"></i> <span>网络分析</span>
          </a>
        </li>
      </ul>
    </section>
  </aside>

  <div class="content-wrapper">
    <section class="content-header">
      <h1>
        测试报告
        <small></small>
      </h1>
      <ol class="breadcrumb">
        <li><a onclick="targetFunc('index.html','indexoverview')" id="indexoverview" href=""><i class="fa fa-dashboard"></i> 概览</a></li>
        
        <li class="active">测试报告</li>
      </ol>
    </section>
    <section class="invoice" id="export">
      <!-- title row -->
      <div class="row">
        <div class="col-xs-12">
          <h2 class="page-header">
            <!-- <i class="fa fa-globe"></i> 
            <small class="pull-right">Date: 2016/3/30</small> -->
          </h2>
        </div>
      </div>
      <div  style="margin-left: 0px;">
      	<table class="" id="reportHeader" style="table-layout:fixed;width: 100%;">
	            <thead>
	            <tr>
	              <th style="width:33.3333%"></th>
	              <th style="width:33.3333%"></th>
	              <th style="width:33.3333%"></th>
	            </tr>
	            </thead>
	            <tbody>
	            	 <tr>
	            		<td style="width:33.3333%">范围</td>
	            		<td style="width:33.3333%">样本</td>
	            		<td style="width:33.3333%"></td>
	            	</tr>
	            </tbody>
	    </table>
      </div> <br>
	  <div><strong>一、本月测试概览</strong></div> 
	  <div id="urlDiv"></div>
      <div class="row">
        <div class="col-xs-12 table-responsive">
          <table class="table table-striped" id="cityInfoTable">
            <thead>
            <tr>
              <th>地域</th>
              <th>样本总数</th>
              <th>有效样本</th>
              <th>互联网下载</th>
              <th>网页浏览</th>
              <th>H5视频</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <div><strong>二、分用户指标统计</strong></div> 
      <div id="userByprobeType">
       <!-- <div class="row">
       
        <div class="col-xs-12 table-responsive">
          <div>1、安卓智能终端用户</div>
           <table class="table table-striped" >
            <thead>
            <tr>
              <th>指标</th>
              <th>有效样本</th>
              <th>95分位值</th>
              <th>85分位值</th>
              <th>75分位值</th>
              <th>平均</th>
            </tr>
            </thead>
            <tbody>
            	
            </tbody>
          </table>
        </div> 
      </div> -->
     </div>
      
     <div><strong>三、分地域指标统计</strong></div> 
      <div id="userBycity">
      	 <!-- <div class="row">
	        <div class="col-xs-12 table-responsive">
	         <div>1、松原</div>
	         <div>互联网下载</div>
	           <table class="table table-striped" >
	            <thead>
	            <tr>
	              <th>指标</th>
	              <th>用户类型</th>
	              <th>95分位值</th>
	              <th>85分位值</th>
	              <th>75分位值</th>
	              <th>平均</th>
	            </tr>
	            </thead>
	            <tbody>
	            	
	            </tbody>
	          </table>
	        </div> 
      	</div>  -->
     </div>
      <div><strong>四、竞品对标分析</strong></div> 
      <div id="jingpinAnalyse">
      	 
     </div>
      <div class="row">
        <div class="col-xs-6">
           <strong>五、质量分析:</strong>
          
          <p class="text-muted well well-sm no-shadow" style="margin-top: 10px;">
            
          </p> 
        </div>
        <div class="col-xs-6">
           <strong>六、本月典型指标（85分位值）</strong>

          <div class="table-responsive">
            <table class="table">
              <tr>
                <th style="width:20%">指标名称</th>
                <th style="width:20%">用户类型</th>
				<th style="width:20%">本区域</th>
				<th style="width:20%">排名</th>
				<th style="width:20%">最优</th>
              </tr>
              
            </table>
          </div> 
        </div>
      </div>

      <div class="row no-print">
        <div class="col-xs-12">
           <!-- <a href="" onclick="targetPrint()" target="_blank" class="btn btn-default" id="printReport"><i class="fa fa-print"></i> Print</a> 
         
           <a type="button" class="btn btn-primary pull-right" style="margin-right: 5px;" target="_blank" onclick="targetPrint()" id="printReport">
            <i class="fa fa-download"></i>下载 
          </a>  -->
          <a type="button" class="btn btn-primary pull-right" style="margin-right: 5px;" onclick="showResultText()">
            <i class="fa fa-download"></i>下载 
          </a>
        </div>
      </div>
    </section>
    <div class="clearfix"></div>
  </div>
  <footer class="main-footer no-print">
    <div class="pull-right hidden-xs">
      
    </div>
    
  </footer>
  <div class="control-sidebar-bg"></div>
</div>

<script src="adminLTE_zx/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script src="adminLTE_zx/bootstrap/js/bootstrap.min.js"></script>
<script src="adminLTE_zx/plugins/fastclick/fastclick.js"></script>
<script src="adminLTE_zx/dist/js/app.min.js"></script>
<script src="adminLTE_zx/dist/js/demo.js"></script>
<script type="text/javascript" src="html2canvas/html2canvas.js"></script>
<script src="common/common.js"></script> 
<script type="text/javascript" src="common/pinyin.js"></script>

<script>
reportDate = location.search.getQueryString("reportDate");  //报告日期
reportProvinceName = location.search.getQueryString("reportProvinceName"); //报告省份
reportProvinceName = decodeURI(reportProvinceName,"UTF-8");

reportBroadType = location.search.getQueryString("reportBroadType"); //报告宽带类型
reportBroadType = decodeURI(reportBroadType,"UTF-8");
reportBroadType = reportBroadType.substr(0,reportBroadType.length-1);

groupid = location.search.getQueryString("groupid"); //groupid


//测试报告跳转到报告打印下载页面
function targetPrint(){
	reportProvinceName = encodeURI(reportProvinceName);
	reportProvinceName = encodeURI(reportProvinceName);  
	
	reportBroadType = encodeURI(reportBroadType);
	reportBroadType = encodeURI(reportBroadType);
	var url = "reportprint.html";
	url = (url + "?key=" + _authkey + "&apiKey=" + apiKey+ "&reportDate=" + reportDate+ "&reportProvinceName=" + reportProvinceName+ "&reportBroadType=" + reportBroadType+ "&groupid=" + groupid);
	$("#printReport").attr('href', url);
	reportProvinceName = decodeURI(reportProvinceName,"UTF-8"); //解决关闭打印页面后再点击下载按钮，省份名显示乱码的问题（还原）
	reportProvinceName = decodeURI(reportProvinceName,"UTF-8"); //解决关闭打印页面后再点击下载按钮，省份名显示乱码的问题（还原）
}

function showResultText(){  
	 var dataUrl;//simpleSumID  export
	 //var sResult=prompt("请输入生成pdf文件名:","");
	 var sResult = pdfName+".pdf";
	 var pinyinstr = codefans_net_CC2PY(pdfName);
	 $("a[class='btn btn-primary pull-right']").hide();
	 var htmlstr = $("#export").html();
	 //alert(htmlstr);
	 //alert(pinyinstr);
	 if(sResult!=null)
	{
	        if(sResult.indexOf('.pdf')>-1){
	  html2canvas(document.getElementById("export"),{
		                       	 allowTaint: true,
		                       	 taintTest: false,
		                       	 onrendered: function(canvas) {
		                           	 canvas.id = "mycanvas";
			                         //document.body.appendChild(canvas);
			                         //生成base64图片数据
		                          	 dataUrl = canvas.toDataURL();
		                          	$.ajax({
											  type : "post",  
										      async : false, //同步执行  
										      url:'creatPdfImport/creatPdfImport',
										      data: { dataUrl: dataUrl, fileName:sResult,randoms: Math.random(),pinYinStr:pinyinstr,htmlStr:htmlstr},
										      text: "Updating...",  
								              dataType: "json",
										      success : function(data) { 
										    	  if(data.filestatus == "ok"){
										    		  
										    		   var iframe = document.getElementById('testResult-download-file-id');
										  				if(!iframe){
											  				iframe = document.createElement("iframe");
											  				iframe.setAttribute("class","page-iframe");
											  				iframe.frameborder = "0";
											  				iframe.id = 'testResult-download-file-id';
											  				iframe.allowTransparency = "true";
											  				document.body.appendChild(iframe);
										  				}
										    		  iframe.src = 'creatPdfImport/downloadPDF?fileName='+ sResult+'&pinYinStr='+pinyinstr;
										    		   $("a[class='btn btn-primary pull-right']").show();
										    		   $("#testResult-download-file-id").hide();
										    	  }else if(data.filestatus == "FileNotFound"){
										    		  $("a[class='btn btn-primary pull-right']").show();
										    		  alert("生成pdf文件失败，找不到pdf文件路径！(No such file or directory)");
										    	  }else if(data.filestatus == "jpgnotfound"){
										    		  $("a[class='btn btn-primary pull-right']").show();
										    		  alert("jpg(No such file or directory)");
										    	  }else{
										    		  $("a[class='btn btn-primary pull-right']").show();
										    	  }
										         
										      },  
										      error : function(errorMsg) { 
										    	  $("a[class='btn btn-primary pull-right']").show();
										    	  alert("您要生成的文件格式不对");
									      }  
									});
							    	 
							    }
							});
	        }else{
	        	$("a[class='btn btn-primary pull-right']").show();
				 alert("要生成pdf文件名格式不对");
	        }
	}else{
		$("a[class='btn btn-primary pull-right']").show();
	        alert("要生成pdf文件名不能为空！");
	}
	 
	 
}

</script>

<!-- 页面数据源接口 begin -->
<script type="text/javascript">

var month = reportDate.substr(4,6); //获取报告月份
var year2 = reportDate.substr(0,4);//获取报告的年份
var firstdate = year2 + '/' + month + '/01'; 
var daydate = new Date(year,month,0);   
var lastdate = year2 + '/' + month + '/'+daydate.getDate(); 
var nextmonth = parseInt(month) + 1;
if (nextmonth == 13) {
    year2 = parseInt(year2) + 1;
    nextmonth = 1;
}
if (nextmonth < 10 && nextmonth != 0) {
	nextmonth = '0' + nextmonth;
}
var nextYMonth = year2.toString()+"/"+nextmonth.toString()+"/01"; //发布日期:下个月的第一天

var lastmonth = parseInt(month) - 1;
var yearlast = reportDate.substr(0,4);//获取报告的年份
if (lastmonth == 0) {
	yearlast = parseInt(yearlast) - 1;
	lastmonth = 12;
}
if (lastmonth < 10 && lastmonth != 0) {
	lastmonth = '0' + lastmonth;
}
var preYMonth = yearlast.toString()+lastmonth.toString();

var regionNum ="";  //地区数量
var cityList=""    ;    //城市列表
var validSampleNum = "0"; //有效样本数
var thisMonthSample = "0"; //本月样本总数
var validSampleRate =""; //样本有效率：有效率=有效样本数/本月样本总数
var lastMonthSample = ""; //上月样本总数
var userNumByGroupid = ""; //用户
var terminalNumByGroupid = ""; //终端
var rpDatasource = "";  //报告的数据来源
var casecountNum = ""; //表中的用例数
var totalURLNum = "0"; //本轮测试共覆盖URL地址数
var internetDownURLNum = "0" ;//互联网下载覆盖URL地址数
var webbrowseURLNum = "0"; //网页浏览覆盖URL地址数
var h5VideoURLNum = "0"; //H5视频覆盖URL地址数
var pdfName = reportProvinceName + reportBroadType+"M家庭宽带品质监测报告("+reportDate+")";
//$("title").html(pdfName); 

$("h2[class='page-header']").append(
		" <i class='fa fa-globe'></i> "+reportProvinceName + reportBroadType+"M家庭宽带品质监测报告("+reportDate+")"+
		" <small class='pull-right'>发布日期: "+thisDate+"</small>"
);
   
//有效样本
 /* $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'../../../provincequalitymap/getValidSampleNum',
    data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	validSampleNum = parseInt(result.ping_test_times);
    },  
    error : function(errorMsg) {  
        alert("有效样本--返回数据出错");  
    }  
}); */ 


//样本有效率
 /* $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'../../../provincequalitymap/getTotalSampleNum',
    data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	thisMonthSample = parseInt(result.new_sample_num);
    	if(thisMonthSample !=0 && thisMonthSample!="0"){
    		validSampleRate = (validSampleNum/thisMonthSample*100).toFixed(2)+"%";
    	}else{
    		validSampleRate=0;
    	}
    },  
    error : function(errorMsg) {  
        alert("样本有效率--返回数据出错");  
    }  
});  */ 

//上月有效样本数
 $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'provincequalitymap/getValidSampleNum',
    data : {month:preYMonth,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	lastMonthSample = parseInt(result.ping_test_times);
    },  
    error : function(errorMsg) {  
        alert("上月有效样本数--返回数据出错");  
    }  
});   
 
//用户
 $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'provincequalitymap/getUsernumByGroupId',
    data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	userNumByGroupid = result.new_user_num;
    },  
    error : function(errorMsg) {  
        alert("用户--返回数据出错");  
    }  
 });
  //终端数
    $.ajax({  
       type : "post",  
       async : false, //同步执行  
       url:'provincequalitymap/getTerminalnumByGroupId',
       data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
       dataType : "json", //返回数据形式为json  
       success : function(result) {  
    	   terminalNumByGroupid = result.new_terminal_num;
       },  
       error : function(errorMsg) {  
           alert("终端--返回数据出错");  
       }  
    });

//用例数
/* $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'creatPdfImport/getCaseCount',
    data : {},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	if(result.msg != 200){
    		casecountNum = "N/A";
    	}else{
    		casecountNum = result.detail.casecount;
    	}
    	
    },  
    error : function(errorMsg) {  
        alert("casecountNum--返回数据出错");  
    }  
 }); */

//拼本月测试概览-地域有效样本tableBody
function appendTablecityinfo(result){
	var htmlStr = "";
	
	for(var i=0;i<result.data.length;i++){
		validSampleNum = parseFloat(validSampleNum)+parseFloat(result.data[i].validsample);
		thisMonthSample = parseFloat(thisMonthSample)+parseFloat(result.data[i].samplenum);
		var subHtmStr = "";
		subHtmStr = "<tr>"+
	    				"<td>"+result.data[i].cityname+"</td>"+
	  					"<td>"+result.data[i].samplenum+"</td>"+
	  					"<td>"+result.data[i].validsample+"</td>"+
	  					"<td>"+result.data[i].internetdownload+"</td>"+
	  					"<td>"+result.data[i].webbrowse+"</td>"+
	  					"<td>"+result.data[i].h5video+"</td>"+
	  				"</tr>";
		htmlStr = htmlStr+subHtmStr;
	}
	
	$("#cityInfoTable tbody").append(htmlStr);
	if(thisMonthSample !=0 && thisMonthSample!="0"){
		validSampleRate = (validSampleNum/thisMonthSample*100).toFixed(2)+"%";
	}else{
		validSampleRate=0;
	}
}
 
 function getURLNum(result){
	for(var i=0;i<result.urldata.length;i++){
		if(result.urldata[i].testtype == "H5视频"){
			h5VideoURLNum = result.urldata[i].url_num;
		}
		if(result.urldata[i].testtype == "网页浏览"){
			webbrowseURLNum = result.urldata[i].url_num;
		}
		if(result.urldata[i].testtype == "互联网下载"){
			internetDownURLNum = result.urldata[i].url_num;
		}
	}
	totalURLNum = parseFloat(h5VideoURLNum)+parseFloat(webbrowseURLNum)+parseFloat(internetDownURLNum);
}
//本月测试概览-地域有效样本
$.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'overviewServicequality/getTerritoryData',
   data : {month:reportDate,groupid:groupid,broadband_type:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
	   if(result.data.length>0){
		   appendTablecityinfo(result);
 	  }else{
 		  alert("地域有效样本--没有数据记录！");
 	  }
	   if(result.urldata.length>0){
		   getURLNum(result);
	   }else{
		   alert("本轮测试覆盖URL为空！");
	   }
	   $("#urlDiv").html("本轮测试共覆盖URL地址"+totalURLNum+"个，其中互联网下载覆盖URL地址"+internetDownURLNum+"个，网页浏览覆盖URL地址"+webbrowseURLNum+"个，H5视频覆盖URL地址"+h5VideoURLNum+"个。");
   },  
   error : function(errorMsg) {  
       alert("地域有效样本--返回数据出错");  
   }  
}); 


// 城市维度 拼tableBody
/* function appendCityTable(result){
	var tableStr = "";
	for(var i=0;i<result.values.length;i++){
		var tdContent = "";
		tableStr = "<tr>"+
			  	"<td>"+result.values[i].city+"</td>"+
			  	"<td>"+casecountNum+"</td>"+
			  	"<td>"+result.values[i].new_sample_num+"</td>"+
			  	"<td>有效样本数</td>";
			  	
		for(var j=0;j<result.values[i].item.length;j++){
			var onetestkpi = "";
			for(var k=0;k<result.values[i].item[j].data.length;k++){
				onetestkpi =  onetestkpi + result.values[i].item[j].data[k].probetype + result.values[i].item[j].typename+"为"+result.values[i].item[j].data[k].value+"  ；";
			}
			tdContent = tdContent + onetestkpi+" <br>";
		} 		  	
		tableStr = tableStr + "<td>"+tdContent+"</td>";
		tableStr = tableStr + "</tr>";
		 
		$("#cityTable tbody").append(tableStr);
	}	
} */
function appendCityTable(result){ 
	var htmlStr = "";
	for(var i=0;i<result.data.length;i++){
		cityList = cityList + result.data[i].cityname+"、";
		htmlStr="<div class='row'> <div class='col-xs-12 table-responsive'> <div><strong>"+(i+1)+"、"+result.data[i].cityname+"</strong></div>";
        				for(var j=0;j<result.data[i].citydata.length;j++){
        					htmlStr = htmlStr + "<div><strong>"+result.data[i].citydata[j].kpitypename+"</strong></div>";
        					htmlStr = htmlStr + "<table class='table table-striped'>"+
        										"<thead>"+
        										"<tr>"+
        											"<th style='width: 22%'>指标</th>"+
        											"<th style='width: 13%'>用户类型</th>"+
        											"<th style='width: 13%'>成功率</th>"+
        											"<th style='width: 13%'>95分位值</th>"+
        											"<th style='width: 13%'>85分位值</th>"+
        											"<th style='width: 13%'>75分位值</th>"+
        											"<th style='width: 13%'>平均</th>"+
        										"</tr>"+
        										"</thead>"+
        										"<tbody>";
        					for(var k=0;k<result.data[i].citydata[j].kpidata.length;k++){
        						for(var m=0;m<result.data[i].citydata[j].kpidata[k].filedata.length;m++){
        							htmlStr = htmlStr + "<tr>";
            						var rowspanNum = result.data[i].citydata[j].kpidata[k].filedata.length;
            						if(m==0){
            							htmlStr = htmlStr + "<td rowspan='"+rowspanNum+"'>"+result.data[i].citydata[j].kpidata[k].fieldname+"</td>";
            						}
            						if(result.data[i].citydata[j].kpidata[k].fieldname.indexOf("成功率") > 0){
            							htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].usertype+"</td>" ;
            							htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].successratevalue+"</td>" ;
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].percent95 != "N/A"){
            								htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent95+"%</td>" ;
            							}else{
            								htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent95+"</td>" ;
            							}
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].percent85 !="N/A"){
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent85+"%</td>" ; 
            							}else{
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent85+"</td>" ; 
            							}
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].percent75 !="N/A"){
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent75+"%</td>" ; 
            							}else{
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent75+"</td>" ; 
            							}
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue !="N/A"){
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue+"%</td>" ;
            							}else{
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue+"</td>" ;
            							}
            							
										htmlStr = htmlStr + "</tr>";	
            						}else{
            							htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].usertype+"</td>" +
            							"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].successratevalue+"</td>" + 
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent95+"</td>" + 
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent85+"</td>" + 
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent75+"</td>" + 
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue+"</td>" ;
										htmlStr = htmlStr + "</tr>";	
            						}
        										
        						}
        					}
        					htmlStr = htmlStr + "</tbody>";
        					htmlStr = htmlStr + "</table>";	
        				}
        				htmlStr = htmlStr + "</div> ";
    		            htmlStr = htmlStr + "</div>";
            			$("#userBycity").append(htmlStr);
	} 
	cityList = cityList.substring(0,cityList.length-1);
}
//城市维度报告明细
$.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'overviewServicequality/getCityData',
   data : {month:reportDate,groupid:groupid,broadband_type:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
	   if(result.data.length>0){
		   regionNum = result.data.length;  //地区数量
	 	   //cityList=result.citydata.citys;  //城市列表
 		  appendCityTable(result);
 	  }else{
 		  regionNum = "";
 		  cityList="";
 		  alert("城市报告明细--没有数据记录！");
 	  }
   },  
   error : function(errorMsg) {  
       alert("城市报告明细--返回数据出错");  
   }  
}); 


 //探针维度 拼tableBody
 /* function appendProbeTable(result){
	 var tableStr = "";
		for(var i=0;i<result.values.length;i++){
			rpDatasource = rpDatasource + result.values[i].probetype+"、";
			var tdContent = "";
			tableStr = "<tr>"+
				  	"<td>"+result.values[i].probetype+"</td>"+
				  	"<td>"+casecountNum+"</td>"+
				  	"<td>"+result.values[i].new_sample_num+"</td>"+
				  	"<td>有效样本数</td>";
				  	
			for(var j=0;j<result.values[i].item.length;j++){
				tdContent = tdContent + result.values[i].item[j].typename + "为" + result.values[i].item[j].value+"  ；";
			} 		  	
			tableStr = tableStr + "<td>"+tdContent+"</td>";
			tableStr = tableStr + "</tr>";
			 
			$("#probetypeTable tbody").append(tableStr);
		}	
		rpDatasource = rpDatasource.substring(0,rpDatasource.length-1);
} */
function appendProbeTable(result){
	 var tableStr = "";
		for(var i=0;i<result.data.length;i++){
			
			tableStr = "<div class='row'>"+
					        "<div class='col-xs-12 table-responsive'>";
			if(result.data[i].type =="PC"){
				tableStr = tableStr+"<div><strong>"+(i+1)+"、桌面终端用户</strong></div>";
				rpDatasource = rpDatasource + "桌面、";
			}
			if(result.data[i].type =="Android"){
				tableStr = tableStr+"<div><strong>"+(i+1)+"、安卓智能终端用户</strong></div>";
				rpDatasource = rpDatasource + "安卓、";
			}
			if(result.data[i].type =="iOS"){
				tableStr = tableStr+"<div><strong>"+(i+1)+"、苹果智能终端用户</strong></div>";
				rpDatasource = rpDatasource + "苹果、";
			}
			tableStr = tableStr + "<table class='table table-striped' >"+
					            "<thead>"+
					            "<tr>"+
					              "<th style='width: 22%'>指标</th>"+
					              "<th style='width: 13%'>有效样本</th>"+
					              "<th style='width: 13%'>成功率</th>"+
					              "<th style='width: 13%'>95分位值</th>"+
					              "<th style='width: 13%'>85分位值</th>"+
					              "<th style='width: 13%'>75分位值</th>"+
					              "<th style='width: 13%'>平均</th>"+
					            "</tr>"+
					            "</thead>"+
					            "<tbody>";
			for(var j=0;j<result.data[i].data.length;j++){
				tableStr = tableStr+
				"<tr>"+
				  	"<td>"+result.data[i].data[j].kpiname+"</td>"+
				  	"<td>"+result.data[i].data[j].validsample+"</td>"+
				  	"<td>"+result.data[i].data[j].successratevalue+"</td>"+
				  	"<td>"+result.data[i].data[j].percent95+"</td>"+
				  	"<td>"+result.data[i].data[j].percent85+"</td>"+
				  	"<td>"+result.data[i].data[j].percent75+"</td>"+
				  	"<td>"+result.data[i].data[j].avgvalue+"</td>"+
			  	"</tr>";
			}		            	
            tableStr = tableStr + "</tbody>";
            tableStr = tableStr + "</table>";
            tableStr = tableStr + "</div> ";
            tableStr = tableStr + "</div>";
			 
			$("#userByprobeType").append(tableStr);
		}	
		rpDatasource = rpDatasource.substring(0,rpDatasource.length-1);
}
//分用户指标统计
$.ajax({  
	   type : "post",  
	   async : false, //同步执行  
	   url:'overviewServicequality/getUserIndicator',
	   data : {month:reportDate,groupid:groupid,broadband_type:reportBroadType},  
	   dataType : "json", //返回数据形式为json  
	   success : function(result) {  
		  if(result.data.length>0){
	 		  appendProbeTable(result);
	 	  }else{
	 		  alert("分用户指标统计--没有数据记录！");
	 	  }
	   },  
	   error : function(errorMsg) {  
	       alert("分用户指标统计--返回数据出错");  
	   }  
	});  


/* $("div[class='row invoice-info']").children("div").eq(0).html(
		"范围<address><strong>"+reportBroadType+"M家庭宽带</strong><br>区域: "+reportProvinceName+"<br>地区: "+regionNum+"个<br>周期: "+firstdate+" --- "+lastdate+"<br>地域: "+cityList+"</address>");
$("div[class='row invoice-info']").children("div").eq(1).html(
		" 样本<address><strong>有效样本:"+validSampleNum+" </strong><br>用户: "+userNumByGroupid+"<br>终端: "+terminalNumByGroupid+"<br>样本有效率: "+validSampleRate+"<br>上月有效样本数: "+lastMonthSample+"</address>");

$("div[class='row invoice-info']").children("div").eq(2).html(
			" <b> </b><br><br><b>编号:</b> #"+groupid+reportBroadType+reportDate+"<br><b>生成日期:</b> "+nextYMonth+"<br><b>数据来源:</b> "+rpDatasource
			); */

$("#reportHeader tbody").append(
		 "<tr><td><strong>"+reportBroadType+"M家庭宽带</strong></td><td><strong>有效样本:"+validSampleNum+" </strong></td><td></td></tr>"+
		 "<tr><td>区域: "+reportProvinceName+"</td><td>用户: "+userNumByGroupid+"</td><td><b>编号:</b> #"+groupid+reportBroadType+reportDate+"</td></tr>"+
		 "<tr><td>地区: "+regionNum+"个</td><td>终端: "+terminalNumByGroupid+"</td><td><b>生成日期:</b> "+nextYMonth+"</td></tr>"+
		 "<tr><td>周期: "+firstdate+"---"+lastdate+"</td><td>样本有效率: "+validSampleRate+"</td><td><b>数据来源:</b> "+rpDatasource+"</td></tr>"+
		 "<tr><td style=\"word-break:break-all;padding-right:15px;\">地域: "+cityList+"</td><td>上月有效样本数: "+lastMonthSample+"</td><td></td></tr>"
		);




//竞品对标分析拼table
function appendJingpinTable(result){ 
	var htmlStr = "";
	for(var i=0;i<result.data.length;i++){
		htmlStr="<div class='row'> <div class='col-xs-12 table-responsive'> <div><strong>"+(i+1)+"、"+result.data[i].kpitypename+"</strong></div>";
       					htmlStr = htmlStr + "<table class='table table-striped'>"+
       										"<thead>"+
       										"<tr>"+
       											"<th style='width: 22%'>指标</th>"+
       											"<th style='width: 13%'>用户类型</th>"+
       											"<th style='width: 13%'>成功率</th>"+
       											"<th style='width: 13%'>95分位值</th>"+
       											"<th style='width: 13%'>85分位值</th>"+
       											"<th style='width: 13%'>75分位值</th>"+
       											"<th style='width: 13%'>平均</th>"+
       										"</tr>"+
       										"</thead>"+
       										"<tbody>";
       					for(var j=0;j<result.data[i].kpidata.length;j++){
       						for(var k=0;k<result.data[i].kpidata[j].probedata.length;k++){
       							htmlStr = htmlStr + "<tr>";
           						var rowspanNum = result.data[i].kpidata[j].probedata.length;
           						if(k==0){
           							htmlStr = htmlStr + "<td rowspan='"+rowspanNum+"'>"+result.data[i].kpidata[j].probename+"</td>";
           						}
        						htmlStr = htmlStr + "<td>"+result.data[i].kpidata[j].probedata[k].operator+"</td>" +
        						"<td>"+result.data[i].kpidata[j].probedata[k].successratevalue+"</td>" + 
								"<td>"+result.data[i].kpidata[j].probedata[k].percent95+"</td>" + 
								"<td>"+result.data[i].kpidata[j].probedata[k].percent85+"</td>" + 
								"<td>"+result.data[i].kpidata[j].probedata[k].percent75+"</td>" + 
								"<td>"+result.data[i].kpidata[j].probedata[k].avgvalue+"</td>" ;
								htmlStr = htmlStr + "</tr>";	
       						}
       					}
       					htmlStr = htmlStr + "</tbody>";
       					htmlStr = htmlStr + "</table>";	
        				
        				htmlStr = htmlStr + "</div> ";
    		            htmlStr = htmlStr + "</div>";
            			$("#jingpinAnalyse").append(htmlStr);
	} 
}
//竞品对标分析
$.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'overviewServicequality/getOperatorData',
   data : {month:reportDate,groupid:groupid,broadband_type:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
	   if(result.data.length>0){
		   regionNum = result.data.length;  //地区数量
	 	   //cityList=result.citydata.citys;  //城市列表
 		  appendJingpinTable(result);
 	  }else{
 		  regionNum = "";
 		  cityList="";
 		  alert("竞品对标分析--没有数据记录！");
 	  }
   },  
   error : function(errorMsg) {  
       alert("竞品对标分析--返回数据出错");  
   }  
}); 



//质量分析
  $.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'provincequalitymap/getServiceQualityCompare',
   data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
	   var htmlstr = "";
	   if(result.data.length>0){
		   htmlstr = "与上月相比，<br>";
		   for(var i=0;i<result.data.length;i++){
			   var substr = "";
			   if(result.data[i].typename == "PC"){
				   substr =  "桌面终端用户：";
				   for(var j=0;j<result.data[i].data.length;j++){
					   substr = substr + result.data[i].data[j].datatype + result.data[i].data[j].data+"，";
				   }
				   substr = substr.substr(0,substr.length-1)+"；";
				   substr = substr+"<br>";
				   htmlstr = htmlstr + substr;
			   }
			   if(result.data[i].typename == "iOS"){
				   substr = "苹果智能终端用户：";
				   for(var j=0;j<result.data[i].data.length;j++){
					   substr = substr + result.data[i].data[j].datatype + result.data[i].data[j].data+"，";
				   }
				   substr = substr.substr(0,substr.length-1)+"；";
				   substr = substr+"<br>";
				   htmlstr = htmlstr + substr;
			   }
			   if(result.data[i].typename == "Android"){
				   substr = "安卓智能终端用户：";
				   for(var j=0;j<result.data[i].data.length;j++){
					   substr = substr + result.data[i].data[j].datatype + result.data[i].data[j].data+"，";
				   }
				   substr = substr.substr(0,substr.length-1)+"；";
				   substr = substr+"<br>";
				   htmlstr = htmlstr + substr;
			   }
			   
		   }
		   
		   //htmlstr = htmlstr.substr(0,htmlstr.length-1)+"。";
		   $("p[class='text-muted well well-sm no-shadow']").append(htmlstr);
	   }else{
		   htmlstr = "暂无数据";
		   $("p[class='text-muted well well-sm no-shadow']").html(htmlstr);
	   }
	   
	   
   },  
   error : function(errorMsg) {  
       alert("质量分析--返回数据出错");  
   }  
});   


//拼本月指标情况tableBody
  function appendTable2(result){
	var htmlStr = "";
	for(var i=0;i<result.data.length;i++){
		var subHtmStr = "";
		var rowspanStr = "";
		if(i==0||i==3){
			rowspanStr = "<td rowspan=\"3\">"+result.data[i].datatype+"</td>";
		}
		if(i==6){
			rowspanStr = "<td rowspan=\"2\">"+result.data[i].datatype+"</td>";
		}
		subHtmStr = "<tr>"+
						rowspanStr+
	    				"<td>"+result.data[i].usertype+"</td>"+
	  					"<td>"+result.data[i].avg_data+"</td>"+
	  					"<td>"+result.data[i].avg_order+"</td>"+
	  					"<td>"+result.data[i].best_data+"</td>"+
	  				"</tr>";
		htmlStr = htmlStr+subHtmStr;
	}
	
  $("table[class='table'] tbody").append(htmlStr);
}

//本月指标情况
$.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'provincequalitymap/getKPIbyGroupid',
   data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
 	 appendTable2(result);
   },  
   error : function(errorMsg) {  
       alert("本月指标情况--返回数据出错");  
   }  
});   




</script>

</body>
</html>
