<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>OTS | 测试报告</title>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="../../bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../bootstrap/css/font-awesome.min.css">
  <link rel="stylesheet" href="../../bootstrap/css/ionicons.min.css"> 
  <link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">
  <link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">

</head> 
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

  <header class="main-header">
    <a onclick="targetFunc('../../../index2.html','indexhead')" id="indexhead" href=""  class="logo">
      <span class="logo-mini"><b>O</b>TS</span>
      <span class="logo-lg"><img src="../../../images/logo.png"> &nbsp;<b>OTS</b>统计平台</span>
    </a>
    <nav class="navbar navbar-static-top" role="navigation">
      <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <div class="navbar-custom-menu">
        <ul class="nav navbar-nav">
          
          <li class="dropdown user user-menu">
            <a  class="" data-toggle="">
              <img src="../../dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
              <span class="hidden-xs"></span>
            </a>
            <ul class="dropdown-menu">
              <!-- User image -->
              <li class="user-header">
                <img src="../../dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">

                <p>
                  Alexander Pierce - Web Developer
                  <small>Member since Nov. 2012</small> 
                </p>
              </li>
              <li class="user-body">
                <div class="row">
                  <div class="col-xs-4 text-center">
                    <a href="#">Followers</a>
                  </div>
                  <div class="col-xs-4 text-center">
                    <a href="#">Sales</a>
                  </div>
                  <div class="col-xs-4 text-center">
                    <a href="#">Friends</a>
                  </div>
                </div>
              </li>
              <li class="user-footer">
                <div class="pull-left">
                  <a href="#" class="btn btn-default btn-flat">Profile</a>
                </div>
                <div class="pull-right">
                  <a href="#" class="btn btn-default btn-flat">Sign out</a>
                </div>
              </li>
            </ul>
          </li>
          <li>
            <a href="" onclick="loginout()">退出</a>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <aside class="main-sidebar">
    <section class="sidebar">
      
      <ul class="sidebar-menu">
        <li class="header">导航栏</li>
        <li class="treeview">
          <!-- <a href="../../../index2.html"> -->
          <a onclick="targetFunc('../../../index2.html','indexOver')" id="indexOver" href="">
            <i><img src="../../../images/dashboard.png"></i> <span>概览</span> <i class=""></i>
          </a>
          
        </li>
        <li>
          <!-- <a href="../charts/chartjs.html"> -->
          <a onclick="targetFunc('../../../chartjs.html','yhAnaly')" id="yhAnaly" href="">
            <i><img src="../../../images/useranalysis.png"></i> <span>用户分析</span>
          </a>
        </li>
        <li>
          <!-- <a href="../charts/chartjs_zd.html"> -->
          <a onclick="targetFunc('../../../chartjs_zd.html','zdAnaly')" href="" id="zdAnaly">
            <i><img src="../../../images/terminalanalysis.png"></i> <span>终端分析</span>
          </a>
        </li>
        <!-- <li>
          <a onclick="targetFunc('../../../chartjs_yw.html','ywAnaly')" href="" id="ywAnaly">
            <i><img src="../../../images/biz.png"></i> <span>业务质量</span>
          </a>
        </li> -->
        <li class="treeview">
          <a href="#">
            <i><img src="../../../images/biz.png"></i> <span>业务质量</span> <i class="fa fa-angle-left pull-right"></i>
          </a>
          <ul class="treeview-menu">
            <li class="active"><a onclick="targetProbeFunc('../../../chartjs_yw.html','ywAndroid','Android')" href="" id="ywAndroid">
            	<i class="fa fa-circle-o"></i>安卓</a></li>
            <li ><a onclick="targetProbeFunc('../../../chartjs_yw.html','ywiOS','iOS')" href="" id="ywiOS">
            	<i class="fa fa-circle-o"></i>苹果</a></li>
            <li ><a onclick="targetProbeFunc('../../../chartjs_yw.html','ywPC','PC')" href="" id="ywPC">
            	<i class="fa fa-circle-o"></i>桌面</a></li>
           <!--  <li ><a onclick="targetProbeFunc('../../../chartjs_yw.html','ywQianrushi','嵌入式')" href="" id="ywQianrushi">
            	<i class="fa fa-circle-o"></i>嵌入式</a></li>
            <li ><a onclick="targetProbeFunc('../../../chartjs_yw.html','ywRuantanzhen','软探针')" href="" id="ywRuantanzhen">
            	<i class="fa fa-circle-o"></i>软探针</a></li> -->
          </ul>
        </li>
        <li>
          <!-- <a href="../charts/chartjs_wl.html"> -->
          <a onclick="targetFunc('../../../chartjs_wl.html','wlAnaly')" href="" id="wlAnaly">
            <i><img src="../../../images/netanalysis.png"></i> <span>网络分析</span>
          </a>
        </li>
        <!--<li>
          <a href="../charts/chartjs_yyong.html">
            <i class="fa fa-table"></i> <span>应用分析</span>
            <small class="label pull-right bg-green">new</small> 
          </a>
        </li>
        <li>
          <a href="#">
            <!--<i class="fa fa-folder"></i> <span>用户行为</span>
            <!--<small class="label pull-right bg-green">new</small> 
          </a>
        </li>-->
      </ul>
    </section>
  </aside>

  <div class="content-wrapper">
    <section class="content-header">
      <h1>
        测试报告
        <small></small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        
        <li class="active">测试报告</li>
      </ol>
    </section>
    <section class="invoice" id="export">
      <!-- title row -->
      <div class="row">
        <div class="col-xs-12">
          <h2 class="page-header">
            <!-- <i class="fa fa-globe"></i> 
            <small class="pull-right">Date: 2016/3/30</small> -->
          </h2>
        </div>
      </div>
      <div class="row invoice-info">
         <div class="col-sm-4 invoice-col">
          <!-- 范围
          <address>
            <strong>50M家庭宽带</strong><br>
            区域: 浙江省<br>
            地区: 10个<br>
            周期: 2016/1/1 --- 2016/1/31<br>
            城市: 杭州、嘉兴、金华、宁波
          </address> -->
        </div>
        <div class="col-sm-4 invoice-col">
         <!--  样本
          <address>
            <strong>有效样本:95 </strong><br>
            用户: 50<br>
            终端: 18<br>
            样本有效率: 95%<br>
            上月样本数: 90
          </address> -->
        </div>
        <div class="col-sm-4 invoice-col">
          <!-- <b> </b><br>
          <br>
          <b>编号:</b> #007612<br>
          <b>发布日期:</b> 2016/2/5<br>
          <b>数据来源:</b> PC 、手机 、嵌入式 -->
        </div>
      </div>
	  <div><strong>一、本月测试概览</strong></div> 
	  <div id="urlDiv"></div>
      <div class="row">
        <div class="col-xs-12 table-responsive">
          <table class="table table-striped" id="cityInfoTable">
            <thead>
            <tr>
              <th>地域</th>
              <th>样本总数</th>
              <th>有效样本</th>
              <th>互联网下载</th>
              <th>网页浏览</th>
              <th>H5视频</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <div><strong>二、分用户指标统计</strong></div> 
      <div id="userByprobeType">
       <!-- <div class="row">
       
        <div class="col-xs-12 table-responsive">
          <div>1、安卓智能终端用户</div>
           <table class="table table-striped" >
            <thead>
            <tr>
              <th>指标</th>
              <th>有效样本</th>
              <th>95分位值</th>
              <th>85分位值</th>
              <th>75分位值</th>
              <th>平均</th>
            </tr>
            </thead>
            <tbody>
            	
            </tbody>
          </table>
        </div> 
      </div> -->
     </div>
      
     <div><strong>三、分地域指标统计</strong></div> 
      <div id="userBycity">
      	 <!-- <div class="row">
	        <div class="col-xs-12 table-responsive">
	         <div>1、松原</div>
	         <div>互联网下载</div>
	           <table class="table table-striped" >
	            <thead>
	            <tr>
	              <th>指标</th>
	              <th>用户类型</th>
	              <th>95分位值</th>
	              <th>85分位值</th>
	              <th>75分位值</th>
	              <th>平均</th>
	            </tr>
	            </thead>
	            <tbody>
	            	
	            </tbody>
	          </table>
	        </div> 
      	</div>  -->
     </div>
      
      <div class="row">
        <div class="col-xs-6">
           <strong>四、质量分析:</strong>
          
          <p class="text-muted well well-sm no-shadow" style="margin-top: 10px;">
            
          </p> 
        </div>
        <div class="col-xs-6">
           <strong>五、本月典型指标（85分位值）</strong>

          <div class="table-responsive">
            <table class="table">
              <tr>
                <th style="width:20%">指标名称</th>
                <th style="width:20%">用户类型</th>
				<th style="width:20%">本省</th>
				<th style="width:20%">排名</th>
				<th style="width:20%">最优</th>
              </tr>
              
            </table>
          </div> 
        </div>
      </div>

      <div class="row no-print">
        <div class="col-xs-12">
          <!-- <a href="invoice-print.html" target="_blank" class="btn btn-default"><i class="fa fa-print"></i> Print</a> 
          
          <a type="button" class="btn btn-primary pull-right" style="margin-right: 5px;" onclick="showResultText()">
            <i class="fa fa-download"></i>下载 
          </a> -->
        </div>
      </div>
    </section>
    <div class="clearfix"></div>
  </div>
  <footer class="main-footer no-print">
    <div class="pull-right hidden-xs">
      
    </div>
    
  </footer>
  <div class="control-sidebar-bg"></div>
</div>

<script src="../../plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script src="../../bootstrap/js/bootstrap.min.js"></script>
<script src="../../plugins/fastclick/fastclick.js"></script>
<script src="../../dist/js/app.min.js"></script>
<script src="../../dist/js/demo.js"></script>
<script type="text/javascript" src="../../../html2canvas/html2canvas.js"></script>
<!--  <script src="../../../common/common.js"></script>   -->

<script>
//增加正则表达式
String.prototype.getQueryString = function(name){
   var reg = new RegExp("(^|&|\\?)"+ name +"=([^&]*)(&|$)"), r;
   if (r=this.match(reg)) return unescape(r[2]); 
   return null;
};

_authkey = location.search.getQueryString("key");
apiKey = location.search.getQueryString("apiKey");
reportDate = location.search.getQueryString("reportDate");  //报告日期
reportProvinceName = location.search.getQueryString("reportProvinceName"); //报告省份
reportProvinceName = decodeURI(reportProvinceName,"UTF-8");

reportBroadType = location.search.getQueryString("reportBroadType"); //报告宽带类型
reportBroadType = decodeURI(reportBroadType,"UTF-8");
reportBroadType = reportBroadType.substr(0,reportBroadType.length-1);

groupid = location.search.getQueryString("groupid"); //groupid
//  
//personName;
//判断用户是否登陆 
if(_authkey==null || _authkey=="null" || _authkey=="" || _authkey=="undefined" || _authkey==undefined){
	  location.href="../../../loginPage_sso.html";
}
$.ajax({
	  type : "post",  
    async : false, //同步执行  
    url:'../../../sysUser/validLogin',
    data : {key:_authkey,apiKey:apiKey},  
    dataType : "json", //返回数据形式为json  
    success : function(res) { 
  	  if (res && res.status != 2) {
  		  //alert(res.username);
				//alert("success");
  		  personName=res.personName;
		  }else {
				location.href="../../../loginPage_sso.html";
				//alert("user为null");
		  }
    },  
    error : function(errorMsg) {  
  	  location.href="../../../loginPage_sso.html";
  	  //alert("返回json格式出错");
    }  
	});
$("span[class='hidden-xs']").html(personName);
//导航栏页面跳转url定位，并附加key和apikey
function targetFunc(url,id){
    url = (url + "?key=" + _authkey + "&apiKey=" + apiKey);
	$("#"+id).attr('href', url);
	$("#"+id).click();
}
//导航栏页面跳转url定位，并附加key和apikey和probetype探针类型
function targetProbeFunc(url,id,probetype){
	probetype = encodeURI(probetype);
	probetype = encodeURI(probetype);  
    url = (url + "?key=" + _authkey + "&apiKey=" + apiKey + "&probetype=" + probetype);
	$("#"+id).attr('href', url);
	$("#"+id).click();
}
/**
 * 点击用户名时退出
 */
function loginout(){
	if(confirm("确定要退出系统吗？")){
		$.ajax({
			  type : "post",  
		      async : false, //同步执行  
		      url:'../../../sysUser/logout',
		      data : {key:_authkey,apiKey:apiKey},  
		      dataType : "json", //返回数据形式为json  
		      success : function(res) { 
		    	  setTimeout(function() {
						location.href="../../../loginPage_sso.html";
				  }, 1000);
		      },  
		      error : function(errorMsg) {  
		    	  location.href="../../../loginPage_sso.html";
		    	  //alert("返回json格式出错");
		      }  
		});
    }else{
    	
    }
}

function showResultText(){  
	 var dataUrl;//simpleSumID  export
	 var sResult=prompt("请输入生成pdf文件名:","");
	if(sResult!=null)
	{
	        if(sResult.indexOf('.pdf')>-1){
	  html2canvas(document.getElementById("export"),{
		                       	 allowTaint: true,
		                       	 taintTest: false,
		                       	 onrendered: function(canvas) {
		                           	 canvas.id = "mycanvas";
			                         //document.body.appendChild(canvas);
			                         //生成base64图片数据
		                          	 dataUrl = canvas.toDataURL();
		                          	$.ajax({
											  type : "post",  
										      async : false, //同步执行  
										      url:'../../../creatPdfImport/creatPdfImport',
										      data: { dataUrl: dataUrl, fileName:sResult,randoms: Math.random()},
										      text: "Updating...",  
								              dataType: "json",
										      success : function(data) { 
										    	  if(data.filestatus == "ok"){
										    		  alert("生成pdf文件成功！");
										    	  }else if(data.filestatus == "FileNotFound"){
										    		  alert("生成pdf文件失败，找不到pdf文件路径！(No such file or directory)");
										    	  }else if(data.filestatus == "jpgnotfound"){
										    		  alert("jpg(No such file or directory)");
										    	  }else{
										    		  
										    	  }
										         
										      },  
										      error : function(errorMsg) { 
										    	  alert("您要生成的文件格式不对");
									      }  
									});
							    	 
							    }
							});
	        }else{
				 alert("要生成pdf文件名格式不对");
	        }
	}else{
	        alert("要生成pdf文件名不能为空！");
	}
}

</script>

<!-- 页面数据源接口 begin -->
<script type="text/javascript">
var myDate = new Date();
var year = myDate.getFullYear().toString();
var monthh = myDate.getMonth()+1;  
var dayy = myDate.getDate();
if (monthh < 10 && monthh != 0) {
	monthh = '0' + monthh;
}
if (dayy < 10 && dayy != 0) {
	dayy = '0' + dayy;
}
var thisDate = year+"/"+monthh+"/"+dayy;//Date:当前年月

//reportBroadType = reportBroadType.substring(0,reportBroadType.length-3);

var month = reportDate.substr(4,6); //获取当前日期的月份
var year2 = reportDate.substr(0,4);//获取当前日期的年份
var firstdate = year2 + '/' + month + '/01'; 
var daydate = new Date(year,month,0);   
var lastdate = year2 + '/' + month + '/'+daydate.getDate(); 
var nextmonth = parseInt(month) + 1;
if (nextmonth == 13) {
    year2 = parseInt(year2) + 1;
    nextmonth = 1;
}
if (nextmonth < 10 && nextmonth != 0) {
	nextmonth = '0' + nextmonth;
}
var nextYMonth = year2.toString()+"/"+nextmonth.toString()+"/01"; //发布日期:下个月的第一天

var lastmonth = parseInt(month) - 1;
var yearlast = reportDate.substr(0,4);//获取当前日期的年份
if (lastmonth == 0) {
	yearlast = parseInt(yearlast) - 1;
	lastmonth = 12;
}
if (lastmonth < 10 && lastmonth != 0) {
	lastmonth = '0' + lastmonth;
}
var preYMonth = yearlast.toString()+lastmonth.toString();

var regionNum ="";  //地区数量
var cityList=""    ;    //城市列表
var validSampleNum = "0"; //有效样本数
var thisMonthSample = "0"; //本月样本总数
var validSampleRate =""; //样本有效率：有效率=有效样本数/本月样本总数
var lastMonthSample = ""; //上月样本总数
var userNumByGroupid = ""; //用户
var terminalNumByGroupid = ""; //终端
var rpDatasource = "";  //报告的数据来源
var casecountNum = ""; //表中的用例数
var totalURLNum = "0"; //本轮测试共覆盖URL地址数
var internetDownURLNum = "0" ;//互联网下载覆盖URL地址数
var webbrowseURLNum = "0"; //网页浏览覆盖URL地址数
var h5VideoURLNum = "0"; //H5视频覆盖URL地址数

$("h2[class='page-header']").append(
		" <i class='fa fa-globe'></i> "+reportProvinceName + reportBroadType+"M家庭宽带品质监测报告("+reportDate+")"+
		" <small class='pull-right'>发布日期: "+thisDate+"</small>"
);
   
//有效样本
 /* $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'../../../provincequalitymap/getValidSampleNum',
    data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	validSampleNum = parseInt(result.ping_test_times);
    },  
    error : function(errorMsg) {  
        alert("有效样本--返回数据出错");  
    }  
}); */ 


//样本有效率
 /* $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'../../../provincequalitymap/getTotalSampleNum',
    data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	thisMonthSample = parseInt(result.new_sample_num);
    	if(thisMonthSample !=0 && thisMonthSample!="0"){
    		validSampleRate = (validSampleNum/thisMonthSample*100).toFixed(2)+"%";
    	}else{
    		validSampleRate=0;
    	}
    },  
    error : function(errorMsg) {  
        alert("样本有效率--返回数据出错");  
    }  
});  */ 

//上月有效样本数
 $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'../../../provincequalitymap/getValidSampleNum',
    data : {month:preYMonth,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	lastMonthSample = parseInt(result.ping_test_times);
    },  
    error : function(errorMsg) {  
        alert("上月有效样本数--返回数据出错");  
    }  
});   
 
//用户
 $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'../../../provincequalitymap/getUsernumByGroupId',
    data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	userNumByGroupid = result.new_user_num;
    },  
    error : function(errorMsg) {  
        alert("用户--返回数据出错");  
    }  
 });
  //终端数
    $.ajax({  
       type : "post",  
       async : false, //同步执行  
       url:'../../../provincequalitymap/getTerminalnumByGroupId',
       data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
       dataType : "json", //返回数据形式为json  
       success : function(result) {  
    	   terminalNumByGroupid = result.new_terminal_num;
       },  
       error : function(errorMsg) {  
           alert("终端--返回数据出错");  
       }  
    });

//用例数
/* $.ajax({  
    type : "post",  
    async : false, //同步执行  
    url:'../../../creatPdfImport/getCaseCount',
    data : {},  
    dataType : "json", //返回数据形式为json  
    success : function(result) {  
    	if(result.msg != 200){
    		casecountNum = "N/A";
    	}else{
    		casecountNum = result.detail.casecount;
    	}
    	
    },  
    error : function(errorMsg) {  
        alert("casecountNum--返回数据出错");  
    }  
 }); */

//拼本月测试概览-地域有效样本tableBody
function appendTablecityinfo(result){
	var htmlStr = "";
	
	for(var i=0;i<result.data.length;i++){
		validSampleNum = parseFloat(validSampleNum)+parseFloat(result.data[i].validsample);
		thisMonthSample = parseFloat(thisMonthSample)+parseFloat(result.data[i].samplenum);
		var subHtmStr = "";
		subHtmStr = "<tr>"+
	    				"<td>"+result.data[i].cityname+"</td>"+
	  					"<td>"+result.data[i].samplenum+"</td>"+
	  					"<td>"+result.data[i].validsample+"</td>"+
	  					"<td>"+result.data[i].internetdownload+"</td>"+
	  					"<td>"+result.data[i].webbrowse+"</td>"+
	  					"<td>"+result.data[i].h5video+"</td>"+
	  				"</tr>";
		htmlStr = htmlStr+subHtmStr;
	}
	
	$("#cityInfoTable tbody").append(htmlStr);
	if(thisMonthSample !=0 && thisMonthSample!="0"){
		validSampleRate = (validSampleNum/thisMonthSample*100).toFixed(2)+"%";
	}else{
		validSampleRate=0;
	}
}
 
 function getURLNum(result){
	for(var i=0;i<result.urldata.length;i++){
		if(result.urldata[i].testtype == "H5视频"){
			h5VideoURLNum = result.urldata[i].url_num;
		}
		if(result.urldata[i].testtype == "网页浏览"){
			webbrowseURLNum = result.urldata[i].url_num;
		}
		if(result.urldata[i].testtype == "互联网下载"){
			internetDownURLNum = result.urldata[i].url_num;
		}
	}
	totalURLNum = parseFloat(h5VideoURLNum)+parseFloat(webbrowseURLNum)+parseFloat(internetDownURLNum);
}
//本月测试概览-地域有效样本
$.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'../../../overviewServicequality/getTerritoryData',
   data : {month:reportDate,groupid:groupid,broadband_type:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
	   if(result.data.length>0){
		   appendTablecityinfo(result);
 	  }else{
 		  alert("地域有效样本--没有数据记录！");
 	  }
	   if(result.urldata.length>0){
		   getURLNum(result);
	   }else{
		   alert("本轮测试覆盖URL为空！");
	   }
	   $("#urlDiv").html("本轮测试共覆盖URL地址"+totalURLNum+"个，其中互联网下载覆盖URL地址"+internetDownURLNum+"个，网页浏览覆盖URL地址"+webbrowseURLNum+"个，H5视频覆盖URL地址"+h5VideoURLNum+"个。");
   },  
   error : function(errorMsg) {  
       alert("地域有效样本--返回数据出错");  
   }  
}); 


// 城市维度 拼tableBody
/* function appendCityTable(result){
	var tableStr = "";
	for(var i=0;i<result.values.length;i++){
		var tdContent = "";
		tableStr = "<tr>"+
			  	"<td>"+result.values[i].city+"</td>"+
			  	"<td>"+casecountNum+"</td>"+
			  	"<td>"+result.values[i].new_sample_num+"</td>"+
			  	"<td>有效样本数</td>";
			  	
		for(var j=0;j<result.values[i].item.length;j++){
			var onetestkpi = "";
			for(var k=0;k<result.values[i].item[j].data.length;k++){
				onetestkpi =  onetestkpi + result.values[i].item[j].data[k].probetype + result.values[i].item[j].typename+"为"+result.values[i].item[j].data[k].value+"  ；";
			}
			tdContent = tdContent + onetestkpi+" <br>";
		} 		  	
		tableStr = tableStr + "<td>"+tdContent+"</td>";
		tableStr = tableStr + "</tr>";
		 
		$("#cityTable tbody").append(tableStr);
	}	
} */
function appendCityTable(result){
	var htmlStr = "";
	for(var i=0;i<result.data.length;i++){
		cityList = cityList + result.data[i].cityname+"、";
		htmlStr="<div class='row'> <div class='col-xs-12 table-responsive'> <div><strong>"+(i+1)+"、"+result.data[i].cityname+"</strong></div>";
        				for(var j=0;j<result.data[i].citydata.length;j++){
        					htmlStr = htmlStr + "<div><strong>"+result.data[i].citydata[j].kpitypename+"</strong></div>";
        					htmlStr = htmlStr + "<table class='table table-striped'>"+
        										"<thead>"+
        										"<tr>"+
        											"<th style='width: 25%'>指标</th>"+
        											"<th style='width: 15%'>用户类型</th>"+
        											"<th style='width: 15%'>95分位值</th>"+
        											"<th style='width: 15%'>85分位值</th>"+
        											"<th style='width: 15%'>75分位值</th>"+
        											"<th style='width: 15%'>平均</th>"+
        										"</tr>"+
        										"</thead>"+
        										"<tbody>";
        					for(var k=0;k<result.data[i].citydata[j].kpidata.length;k++){
        						for(var m=0;m<result.data[i].citydata[j].kpidata[k].filedata.length;m++){
        							htmlStr = htmlStr + "<tr>";
            						var rowspanNum = result.data[i].citydata[j].kpidata[k].filedata.length;
            						if(m==0){
            							htmlStr = htmlStr + "<td rowspan='"+rowspanNum+"'>"+result.data[i].citydata[j].kpidata[k].fieldname+"</td>";
            						}
            						if(result.data[i].citydata[j].kpidata[k].fieldname.indexOf("成功率") > 0){
            							htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].usertype+"</td>" ;
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].percent95 != "N/A"){
            								htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent95+"%</td>" ;
            							}else{
            								htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent95+"</td>" ;
            							}
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].percent85 !="N/A"){
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent85+"%</td>" ; 
            							}else{
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent85+"</td>" ; 
            							}
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].percent75 !="N/A"){
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent75+"%</td>" ; 
            							}else{
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent75+"</td>" ; 
            							}
            							if(result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue !="N/A"){
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue+"%</td>" ;
            							}else{
            								htmlStr = htmlStr +"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue+"</td>" ;
            							}
            							
										htmlStr = htmlStr + "</tr>";	
            						}else{
            							htmlStr = htmlStr + "<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].usertype+"</td>" +
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent95+"</td>" + 
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent85+"</td>" + 
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].percent75+"</td>" + 
										"<td>"+result.data[i].citydata[j].kpidata[k].filedata[m].avgvalue+"</td>" ;
										htmlStr = htmlStr + "</tr>";	
            						}
        										
        						}
        					}
        					htmlStr = htmlStr + "</tbody>";
        					htmlStr = htmlStr + "</table>";	
        				}
        				htmlStr = htmlStr + "</div> ";
    		            htmlStr = htmlStr + "</div>";
            			$("#userBycity").append(htmlStr);
	} 
	cityList = cityList.substring(0,cityList.length-1);
}
//城市维度报告明细
$.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'../../../overviewServicequality/getCityData',
   data : {month:reportDate,groupid:groupid,broadband_type:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
	   if(result.data.length>0){
		   regionNum = result.data.length;  //地区数量
	 	   //cityList=result.citydata.citys;  //城市列表
 		  appendCityTable(result);
 	  }else{
 		  regionNum = "";
 		  cityList="";
 		  alert("城市报告明细--没有数据记录！");
 	  }
   },  
   error : function(errorMsg) {  
       alert("城市报告明细--返回数据出错");  
   }  
}); 


 //探针维度 拼tableBody
 /* function appendProbeTable(result){
	 var tableStr = "";
		for(var i=0;i<result.values.length;i++){
			rpDatasource = rpDatasource + result.values[i].probetype+"、";
			var tdContent = "";
			tableStr = "<tr>"+
				  	"<td>"+result.values[i].probetype+"</td>"+
				  	"<td>"+casecountNum+"</td>"+
				  	"<td>"+result.values[i].new_sample_num+"</td>"+
				  	"<td>有效样本数</td>";
				  	
			for(var j=0;j<result.values[i].item.length;j++){
				tdContent = tdContent + result.values[i].item[j].typename + "为" + result.values[i].item[j].value+"  ；";
			} 		  	
			tableStr = tableStr + "<td>"+tdContent+"</td>";
			tableStr = tableStr + "</tr>";
			 
			$("#probetypeTable tbody").append(tableStr);
		}	
		rpDatasource = rpDatasource.substring(0,rpDatasource.length-1);
} */
function appendProbeTable(result){
	 var tableStr = "";
		for(var i=0;i<result.data.length;i++){
			
			tableStr = "<div class='row'>"+
					        "<div class='col-xs-12 table-responsive'>";
			if(result.data[i].type =="PC"){
				tableStr = tableStr+"<div><strong>"+(i+1)+"、桌面终端用户</strong></div>";
				rpDatasource = rpDatasource + "桌面、";
			}
			if(result.data[i].type =="Android"){
				tableStr = tableStr+"<div><strong>"+(i+1)+"、安卓智能终端用户</strong></div>";
				rpDatasource = rpDatasource + "安卓、";
			}
			if(result.data[i].type =="iOS"){
				tableStr = tableStr+"<div><strong>"+(i+1)+"、苹果智能终端用户</strong></div>";
				rpDatasource = rpDatasource + "苹果、";
			}
			tableStr = tableStr + "<table class='table table-striped' >"+
					            "<thead>"+
					            "<tr>"+
					              "<th style='width: 25%'>指标</th>"+
					              "<th style='width: 15%'>有效样本</th>"+
					              "<th style='width: 15%'>95分位值</th>"+
					              "<th style='width: 15%'>85分位值</th>"+
					              "<th style='width: 15%'>75分位值</th>"+
					              "<th style='width: 15%'>平均</th>"+
					            "</tr>"+
					            "</thead>"+
					            "<tbody>";
			for(var j=0;j<result.data[i].data.length;j++){
				tableStr = tableStr+
				"<tr>"+
				  	"<td>"+result.data[i].data[j].kpiname+"</td>"+
				  	"<td>"+result.data[i].data[j].validsample+"</td>"+
				  	"<td>"+result.data[i].data[j].percent95+"</td>"+
				  	"<td>"+result.data[i].data[j].percent85+"</td>"+
				  	"<td>"+result.data[i].data[j].percent75+"</td>"+
				  	"<td>"+result.data[i].data[j].avgvalue+"</td>"+
			  	"</tr>";
			}		            	
            tableStr = tableStr + "</tbody>";
            tableStr = tableStr + "</table>";
            tableStr = tableStr + "</div> ";
            tableStr = tableStr + "</div>";
			 
			$("#userByprobeType").append(tableStr);
		}	
		rpDatasource = rpDatasource.substring(0,rpDatasource.length-1);
}
//分用户指标统计
$.ajax({  
	   type : "post",  
	   async : false, //同步执行  
	   url:'../../../overviewServicequality/getUserIndicator',
	   data : {month:reportDate,groupid:groupid,broadband_type:reportBroadType},  
	   dataType : "json", //返回数据形式为json  
	   success : function(result) {  
		  if(result.data.length>0){
	 		  appendProbeTable(result);
	 	  }else{
	 		  alert("分用户指标统计--没有数据记录！");
	 	  }
	   },  
	   error : function(errorMsg) {  
	       alert("分用户指标统计--返回数据出错");  
	   }  
	});  


$("div[class='row invoice-info']").children("div").eq(0).html(
		"范围<address><strong>"+reportBroadType+"M家庭宽带</strong><br>区域: "+reportProvinceName+"<br>地区: "+regionNum+"个<br>周期: "+firstdate+" --- "+lastdate+"<br>城市: "+cityList+"</address>");
$("div[class='row invoice-info']").children("div").eq(1).html(
		" 样本<address><strong>有效样本:"+validSampleNum+" </strong><br>用户: "+userNumByGroupid+"<br>终端: "+terminalNumByGroupid+"<br>样本有效率: "+validSampleRate+"<br>上月有效样本数: "+lastMonthSample+"</address>");

$("div[class='row invoice-info']").children("div").eq(2).html(
			" <b> </b><br><br><b>编号:</b> #"+groupid+reportBroadType+reportDate+"<br><b>生成日期:</b> "+nextYMonth+"<br><b>数据来源:</b> "+rpDatasource
			);


//质量分析
  $.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'../../../provincequalitymap/getServiceQualityCompare',
   data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
	   var htmlstr = "";
	   if(result.data.length>0){
		   htmlstr = "与上月相比，<br>";
		   for(var i=0;i<result.data.length;i++){
			   var substr = "";
			   if(result.data[i].typename == "PC"){
				   substr =  "桌面终端用户：";
				   for(var j=0;j<result.data[i].data.length;j++){
					   substr = substr + result.data[i].data[j].datatype + result.data[i].data[j].data+"，";
				   }
				   substr = substr.substr(0,substr.length-1)+"；";
				   substr = substr+"<br>";
				   htmlstr = htmlstr + substr;
			   }
			   if(result.data[i].typename == "iOS"){
				   substr = "苹果智能终端用户：";
				   for(var j=0;j<result.data[i].data.length;j++){
					   substr = substr + result.data[i].data[j].datatype + result.data[i].data[j].data+"，";
				   }
				   substr = substr.substr(0,substr.length-1)+"；";
				   substr = substr+"<br>";
				   htmlstr = htmlstr + substr;
			   }
			   if(result.data[i].typename == "Android"){
				   substr = "安卓智能终端用户：";
				   for(var j=0;j<result.data[i].data.length;j++){
					   substr = substr + result.data[i].data[j].datatype + result.data[i].data[j].data+"，";
				   }
				   substr = substr.substr(0,substr.length-1)+"；";
				   substr = substr+"<br>";
				   htmlstr = htmlstr + substr;
			   }
			   
		   }
		   
		   //htmlstr = htmlstr.substr(0,htmlstr.length-1)+"。";
		   $("p[class='text-muted well well-sm no-shadow']").append(htmlstr);
	   }else{
		   htmlstr = "暂无数据";
		   $("p[class='text-muted well well-sm no-shadow']").html(htmlstr);
	   }
	   
	   
   },  
   error : function(errorMsg) {  
       alert("质量分析--返回数据出错");  
   }  
});   


//拼本月指标情况tableBody
  function appendTable2(result){
	var htmlStr = "";
	for(var i=0;i<result.data.length;i++){
		var subHtmStr = "";
		subHtmStr = "<tr>"+
	    				"<td>"+result.data[i].datatype+"</td>"+
	    				"<td>"+result.data[i].usertype+"</td>"+
	  					"<td>"+result.data[i].avg_data+"</td>"+
	  					"<td>"+result.data[i].avg_order+"</td>"+
	  					"<td>"+result.data[i].best_data+"</td>"+
	  				"</tr>";
		htmlStr = htmlStr+subHtmStr;
	}
	
  $("table[class='table'] tbody").append(htmlStr);
}

//本月指标情况
$.ajax({  
   type : "post",  
   async : false, //同步执行  
   url:'../../../provincequalitymap/getKPIbyGroupid',
   data : {month:reportDate,groupid:groupid,broadType:reportBroadType},  
   dataType : "json", //返回数据形式为json  
   success : function(result) {  
 	 appendTable2(result);
   },  
   error : function(errorMsg) {  
       alert("本月指标情况--返回数据出错");  
   }  
});   




</script>

</body>
</html>
