package com.qualitymap.dao.impl;

import java.util.List;
import java.util.Map;

import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.transform.Transformers;

import com.qualitymap.dao.ServicequalityGroupidPingDao;
import com.qualitymap.dao.ServicequalityGroupidWebbrowsingDao;
import com.qualitymap.dao.ServicequalityOrgidPingDao;
import com.qualitymap.dao.ServicequalityOrgidWebbrowsingDao;

/**
 * 
 * @author kongxiangchun
 * 
 */
public class ServicequalityGroupidWebbrowsingDaoImpl implements ServicequalityGroupidWebbrowsingDao {

	private SessionFactory sessionFactory;

	
	
	public void setSessionFactory(SessionFactory sessionFactory) {
		this.sessionFactory = sessionFactory;
	}

	public Session getSession() {
		return sessionFactory.getCurrentSession();
	}


	/**
	 * 获取页面元素打开成功率趋势数据
	 */
	@Override
	public List<Map<String, Object>> getPageSuccessData(String groupid) {
		String sql = " SELECT sum(page_success_rate*page_test_times)/sum(page_test_times) page_success_rate ,month FROM servicequality_groupid_webbrowsing WHERE `groupid` in ("+groupid+")  GROUP BY month,groupid ";

		List<Map<String, Object>> queryList = this.getSession().createSQLQuery(sql).setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).list();
		return queryList;
	}

	/**
	 * 获取页面元素打开成功率的排名
	 */
	@Override
	public List<Map<String, Object>> getPageSuccessOrder(String thismonth, String premonth, String groupid) {
		String sql = " SELECT ifnull(sum(page_success_rate*page_test_times)/sum(page_test_times),0) page_success_rate ," +
				"ifnull((SELECT ifnull(sum(page_success_rate * page_test_times) / sum(page_test_times),0) pre_page_success_rate FROM servicequality_groupid_webbrowsing b WHERE `month` = '"+premonth+"' and b.groupid = a.groupid GROUP BY groupid ),0) pre_page_success_rate " +
				",groupname FROM servicequality_groupid_webbrowsing a WHERE `groupid` in ("+groupid+") and month = '"+thismonth+"' GROUP BY groupid order by page_success_rate desc ";
		
		List<Map<String, Object>> queryList = this.getSession().createSQLQuery(sql).setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).list();
		return queryList;
	}
	
	/**
	 * 获取上下月平均页面元素打开成功率
	 */
	@Override
	public List<Map<String, Object>> getAvgPageSuccessRate(String yearMonth, String lastMonth, String groupid) {
		String sql = " SELECT sum(page_test_times * page_success_rate) /SUM(page_test_times) avg_page_success_rate,`month` " + " FROM servicequality_groupid_webbrowsing WHERE" + " `month` in (" + yearMonth + ","
				+ lastMonth + ") AND groupid IN (" + groupid + ") GROUP BY `month` order by month ";

		List<Map<String, Object>> queryList = this.getSession().createSQLQuery(sql).setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).list();
		return queryList;
	}

	/**
	 * 获取上下月页面元素打开达标率
	 */
	@Override
	public List<Map<String, Object>> getPageStandardRate(String yearMonth, String lastMonth, String groupid) {
		String sql = " SELECT sum(page_test_times * page_standard_rate) /SUM(page_test_times) page_standard_rate,`month` " + " FROM servicequality_groupid_webbrowsing WHERE" + " `month` in (" + yearMonth + "," + lastMonth
				+ ") AND groupid IN (" + groupid + ") GROUP BY `month` order by month";

		List<Map<String, Object>> queryList = this.getSession().createSQLQuery(sql).setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).list();
		return queryList;
	}

	/**
	 * 获取上下月95%用户页面时延
	 */
	@Override
	public List<Map<String, Object>> getTop90PageDelay(String yearMonth, String lastMonth, String groupid) {
		String sql = " SELECT sum(page_test_times * top95_page_delay) /SUM(page_test_times) top90_page_delay,`month` " + " FROM servicequality_groupid_webbrowsing WHERE" + " `month` in (" + yearMonth + ","
				+ lastMonth + ") AND groupid IN (" + groupid + ") GROUP BY `month` order by month ";

		List<Map<String, Object>> queryList = this.getSession().createSQLQuery(sql).setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).list();
		return queryList;
	}
	
	/**
	 * 获取上下月90%用户页面元素打开成功率
	 */
	@Override
	public List<Map<String, Object>> getTop90PageSuccessRate(String yearMonth, String lastMonth, String groupid) {
		String sql = " SELECT sum(page_test_times * top95_page_success_rate) /SUM(page_test_times) top90_page_success_rate,`month` " + " FROM servicequality_groupid_webbrowsing WHERE" + " `month` in (" + yearMonth + "," + lastMonth
				+ ") AND groupid IN (" + groupid + ") GROUP BY `month` order by month";

		List<Map<String, Object>> queryList = this.getSession().createSQLQuery(sql).setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP).list();
		return queryList;
	}
	
}
